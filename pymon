#!/usr/bin/env python3
"""
PyMon - Automatic Python Script Monitor
Usage: pymon <script.py> [args...] or activate for auto-monitoring
"""

import sys
import os
import subprocess

# Add the workspace to path
WORKSPACE = "/project/workspace"
RUNNER_PATH = os.path.join(WORKSPACE, "runner.py")

def main():
    if len(sys.argv) < 2:
        print("ğŸ” PyMon - Python Script Monitor")
        print("\nğŸ“š Usage:")
        print("  pymon <script.py> [args...]  - Run script with monitoring")
        print("  pymon activate               - Install as default python3")
        print("  pymon deactivate             - Remove from default")
        print("  pymon status                 - Check monitoring status")
        print("  pymon help                   - Show this help")
        print("\nğŸ’¡ Examples:")
        print("  pymon err.py")
        print("  pymon train.py --epochs 100")
        sys.exit(1)
    
    command = sys.argv[1]
    
    if command == "activate":
        activate_monitoring()
    elif command == "deactivate":
        deactivate_monitoring()
    elif command == "status":
        show_status()
    elif command == "help":
        show_help()
    else:
        # Run the script with monitoring
        run_with_monitoring()

def run_with_monitoring():
    """Run a Python script through the runner for monitoring"""
    # Pass all arguments after 'pymon' to runner.py
    args = [sys.executable, RUNNER_PATH] + sys.argv[1:]
    
    try:
        result = subprocess.run(args)
        sys.exit(result.returncode)
    except KeyboardInterrupt:
        print("\nâš ï¸  Monitoring interrupted by user")
        sys.exit(130)
    except Exception as e:
        print(f"âŒ Error running monitor: {e}")
        sys.exit(1)

def activate_monitoring():
    """Install pymon as the default python3 command"""
    print("ğŸš€ Activating Python monitoring globally...")
    
    shell = os.environ.get('SHELL', '/bin/bash')
    
    if 'zsh' in shell:
        rc_file = os.path.expanduser("~/.zshrc")
    else:
        rc_file = os.path.expanduser("~/.bashrc")
    
    pymon_path = os.path.abspath(__file__)
    alias_line = f'\n# PyMon - Auto monitoring\nalias python3="{pymon_path}"\n'
    
    # Check if already activated
    if os.path.exists(rc_file):
        with open(rc_file, 'r') as f:
            content = f.read()
            if 'PyMon - Auto monitoring' in content:
                print("âš ï¸  PyMon is already activated!")
                return
    
    # Add alias
    with open(rc_file, 'a') as f:
        f.write(alias_line)
    
    print("âœ… Monitoring activated!")
    print(f"   Modified: {rc_file}")
    print(f"\nğŸ”„ Please run: source {rc_file}")
    print("   Or restart your terminal")
    print("\nğŸ¯ Now 'python3 script.py' will automatically monitor!")

def deactivate_monitoring():
    """Remove pymon from default"""
    print("ğŸ”´ Deactivating monitoring...")
    
    shell = os.environ.get('SHELL', '/bin/bash')
    
    if 'zsh' in shell:
        rc_file = os.path.expanduser("~/.zshrc")
    else:
        rc_file = os.path.expanduser("~/.bashrc")
    
    if not os.path.exists(rc_file):
        print("âš ï¸  No configuration file found")
        return
    
    # Read and remove PyMon lines
    with open(rc_file, 'r') as f:
        lines = f.readlines()
    
    new_lines = []
    skip_next = False
    found = False
    
    for i, line in enumerate(lines):
        if '# PyMon - Auto monitoring' in line:
            found = True
            skip_next = True
            continue
        if skip_next and 'alias python3=' in line:
            skip_next = False
            continue
        new_lines.append(line)
    
    if found:
        with open(rc_file, 'w') as f:
            f.writelines(new_lines)
        print("âœ… Monitoring deactivated!")
        print(f"   Modified: {rc_file}")
        print(f"\nğŸ”„ Please run: source {rc_file}")
        print("   Or restart your terminal")
    else:
        print("âš ï¸  PyMon was not activated")

def show_status():
    """Show current monitoring status"""
    print("ğŸ“Š PyMon Status")
    print("=" * 50)
    print(f"ğŸ”§ Runner:     {RUNNER_PATH}")
    print(f"ğŸŒ Server:     http://localhost:5000")
    print(f"ğŸ’¾ Data file:  {os.path.join(WORKSPACE, 'data.json')}")
    print(f"ğŸ“ Workspace:  {WORKSPACE}")
    
    # Check if activated
    shell = os.environ.get('SHELL', '/bin/bash')
    rc_file = os.path.expanduser("~/.zshrc" if 'zsh' in shell else "~/.bashrc")
    
    activated = False
    if os.path.exists(rc_file):
        with open(rc_file, 'r') as f:
            if 'PyMon - Auto monitoring' in f.read():
                activated = True
    
    status_emoji = "âœ…" if activated else "âŒ"
    print(f"{status_emoji} Status:    {'Active' if activated else 'Inactive'}")
    
    if not activated:
        print("\nğŸ’¡ Tip: Run 'pymon activate' to enable auto-monitoring")
    
    # Check if server is running
    try:
        import requests
        response = requests.get("http://localhost:5000/view", timeout=2)
        print("ğŸŸ¢ Server:    Running")
    except:
        print("ğŸ”´ Server:    Not running")
        print("   Start with: python3 server.py")

def show_help():
    """Show detailed help"""
    print("""
ğŸ” PyMon - Python Script Monitor
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“– DESCRIPTION:
   Monitor Python scripts with automatic logging, system metrics,
   and remote data collection.

ğŸ¯ USAGE:
   pymon <script.py> [args...]  Run script with monitoring
   pymon activate               Enable auto-monitoring
   pymon deactivate             Disable auto-monitoring
   pymon status                 Show current status
   pymon help                   Show this help

ğŸ’¡ EXAMPLES:
   # Run a script with monitoring
   pymon train.py --epochs 100
   
   # Enable automatic monitoring
   pymon activate
   
   # Now python3 automatically monitors!
   python3 train.py
   
   # Check status
   pymon status
   
   # Disable when done
   pymon deactivate

ğŸ“Š FEATURES:
   â€¢ Captures stdout/stderr
   â€¢ System metrics (CPU, RAM, disk, network)
   â€¢ Timestamped structured logs
   â€¢ Remote data storage
   â€¢ Unique run IDs
   â€¢ Error tracking

ğŸŒ SERVER:
   Start the server before monitoring:
   python3 server.py
   
   View logs:
   curl http://localhost:5000/view

ğŸ“ FILES:
   â€¢ runner.py  - Monitoring wrapper
   â€¢ server.py  - Data collection server
   â€¢ data.json  - Stored execution logs
   â€¢ pymon      - This CLI tool
""")

if __name__ == "__main__":
    main()